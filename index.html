<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Democracy App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            color: #1A365D; /* Navy text */
            overflow-x: hidden; /* Prevent horizontal scroll due to sidebar */
        }

        /* Custom colors for bill types */
        .federal-bill { border-left-color: #EF4444; /* Red */ }
        .state-bill { border-left-color: #F59E0B; /* Orange */ }
        .county-bill { border-left-color: #10B981; /* Green */ }

        /* Sidebar styles */
        .sidebar {
            width: 250px; /* Fixed width for sidebar */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        .sidebar.open {
            transform: translateX(0);
        }

        /* Overlay for when sidebar is open */
        .overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* Main content area adjustment when sidebar is open (optional, for larger screens) */
        @media (min-width: 768px) {
            .main-content {
                margin-left: 0;
                transition: margin-left 0.3s ease-in-out;
            }
            .main-content.shifted {
                margin-left: 250px;
            }
        }

        /* Swipe card specific styles */
        .swipe-card-container {
            touch-action: pan-y; /* Allow vertical scroll, but handle horizontal touch */
            position: relative;
            overflow: hidden; /* Hide overflow of check/cross icons */
        }

        .swipe-card {
            transition: transform 0.1s ease-out; /* Slower transition for snap-back */
            cursor: grab;
            position: relative;
            z-index: 10; /* Ensure card is above icons */
        }

        .swipe-card.locked {
            pointer-events: none; /* Disable interaction after voting */
            cursor: default;
            opacity: 0.7;
        }

        .vote-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 5; /* Below the card */
        }

        .vote-indicator.show {
            opacity: 1;
        }

        .vote-indicator.yes {
            background-color: rgba(76, 175, 80, 0.2); /* Green with transparency */
            color: #4CAF50; /* Green */
        }

        .vote-indicator.no {
            background-color: rgba(244, 67, 54, 0.2); /* Red with transparency */
            color: #F44336; /* Red */
        }

        /* Hide scrollbar for aesthetics */
        ::-webkit-scrollbar {
            display: none;
        }
        html {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Map specific styles */
        #map-container {
            width: 100%;
            height: 300px; /* Fixed height for the map container */
            background-color: #e0e0e0; /* Light grey map background */
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            position: relative;
            touch-action: none; /* Prevent default browser touch actions */
        }

        #map-canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none; /* Prevent default browser touch actions */
        }

        .rep-info-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            max-width: 90%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .rep-info-modal.show {
            opacity: 1;
            visibility: visible;
        }

        /* Budget specific colors */
        .funding-red { background-color: #F44336; color: white; } /* Critically Underfunded */
        .funding-yellow { background-color: #FFC107; color: black; } /* Under Optimal */
        .funding-green { background-color: #4CAF50; color: white; } /* Near Optimal */
        .funding-blue { background-color: #2196F3; color: white; } /* Overfunded */

        .border-funding-red { border-color: #F44336; }
        .border-funding-yellow { border-color: #FFC107; }
        .border-funding-green { border-color: #4CAF50; }
        .border-funding-blue { border-color: #2196F3; }

        .text-funding-red { color: #F44336; }
        .text-funding-yellow { color: #FFC107; }
        .text-funding-green { color: #4CAF50; }
        .text-funding-blue { color: #2196F3; }

        .budget-branch-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .budget-branch-button:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-white shadow-lg flex flex-col p-4 md:p-6">
        <button id="close-sidebar" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 focus:outline-none" aria-label="Close navigation menu">
            <i class="fas fa-times"></i>
        </button>
        <div class="mt-12 flex-grow">
            <h2 class="text-xl font-bold mb-6 text-navy-dark">Menu</h2>
            <ul class="space-y-4">
                <li><a href="#" data-page="home" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to Home page"><i class="fas fa-home mr-3"></i>Home</a></li>
                <li><a href="#" data-page="legislation" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to Legislation page"><i class="fas fa-gavel mr-3"></i>Legislation</a></li>
                <li><a href="#" data-page="budget" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to Budget page"><i class="fas fa-money-bill-wave mr-3"></i>Budget</a></li>
                <li><a href="#" data-page="my-votes" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to My Votes page"><i class="fas fa-check-square mr-3"></i>My Votes</a></li>
                <li><a href="#" data-page="my-profile" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to My Profile page"><i class="fas fa-user-circle mr-3"></i>My Profile</a></li>
                <li><a href="#" data-page="my-rep" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to My Representative page"><i class="fas fa-user-tie mr-3"></i>My Rep</a></li>
                <li><a href="#" data-page="support" class="nav-link flex items-center p-3 rounded-lg text-lg font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Go to Support page"><i class="fas fa-life-ring mr-3"></i>Support</a></li>
            </ul>
        </div>
    </nav>

    <div id="overlay" class="overlay fixed inset-0"></div>

    <div id="main-content" class="flex-grow flex flex-col transition-all duration-300 ease-in-out">
        <header class="bg-navy-dark text-white p-4 shadow-md flex items-center justify-between">
            <button id="open-sidebar" class="text-white text-2xl focus:outline-none focus:ring-2 focus:ring-blue-300 rounded-md p-1" aria-label="Open navigation menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="text-xl font-semibold">Direct Democracy</h1>
            <div class="w-8"></div> </header>

        <main class="flex-grow p-4 overflow-y-auto">
            <section id="home-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">Your Updates</h2>
                <div id="news-feed-list" class="space-y-6">
                    </div>
            </section>

            <section id="legislation-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">Active Legislation</h2>

                <div id="swipe-bill-container" class="swipe-card-container relative w-full max-w-md mx-auto mb-6 bg-white rounded-xl shadow-lg overflow-hidden">
                    <div id="swipe-bill-vote-yes" class="vote-indicator yes"><i class="fas fa-check"></i></div>
                    <div id="swipe-bill-vote-no" class="vote-indicator no"><i class="fas fa-times"></i></div>
                    <div id="swipe-bill-card" class="swipe-card p-6 flex flex-col justify-between h-full">
                        <h3 class="text-xl font-semibold text-navy-dark mb-2" id="swipe-bill-title"></h3>
                        <p class="text-sm text-gray-500 mb-4">Voting ends: <span id="swipe-bill-deadline"></span></p>
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="text-sm font-medium">Participation: <span id="swipe-bill-participation"></span>%</span>
                            <span id="swipe-bill-type" class="text-xs font-semibold px-2 py-1 rounded-full text-white"></span>
                        </div>
                        <div id="swipe-bill-voted-status" class="hidden mt-4 text-center text-lg font-bold text-gray-700"></div>
                    </div>
                </div>

                <div id="other-bills-list" class="space-y-4">
                    </div>
            </section>

            <section id="bill-detail-page" class="page hidden">
                <header class="flex items-center mb-4">
                    <button id="back-to-legislation" class="text-navy-dark text-2xl mr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Back to Legislation list">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-navy-dark" id="detail-bill-title"></h2>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-navy-dark mb-3">Summary</h3>
                    <div id="detail-bill-summary" class="text-gray-700 leading-relaxed space-y-3"></div>
                    <button id="view-pdf-button" class="mt-6 px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="View full text of the bill in PDF format">View PDF</button>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-navy-dark mb-4">Comment Board</h3>
                    <div id="official-comment" class="bg-navy-dark text-white p-4 rounded-lg mb-4 shadow-inner">
                        <div class="flex items-center mb-2">
                            <img id="official-avatar" class="w-10 h-10 rounded-full mr-3 border-2 border-white" alt="Representative's Avatar">
                            <span class="font-bold text-lg" id="official-name"></span>
                        </div>
                        <p class="text-sm italic mb-2">Official Stance:</p>
                        <p class="text-base" id="official-stance"></p>
                    </div>

                    <div id="user-comments-list" class="space-y-4">
                        </div>
                </div>
            </section>

            <section id="budget-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">Budgets for Your Area</h2>
                <div id="budgets-list" class="space-y-4">
                    </div>
            </section>

            <section id="budget-detail-page" class="page hidden">
                <header class="flex items-center mb-4">
                    <button id="back-to-budgets" class="text-navy-dark text-2xl mr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Back to Budgets list">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-navy-dark" id="budget-detail-title"></h2>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-navy-dark mb-3">Your Virtual Wallet</h3>
                    <p class="text-gray-700 text-2xl font-bold mb-4">$<span id="wallet-amount">0.00</span></p>
                    <p class="text-gray-500 text-sm">Allocate your portion of the budget to areas that matter most to you.</p>
                </div>

                <h3 class="text-xl font-semibold text-navy-dark mb-4">Budget Branches</h3>
                <div id="budget-branches-list" class="space-y-4">
                    </div>
            </section>

            <section id="department-detail-page" class="page hidden">
                <header class="flex items-center mb-4">
                    <button id="back-to-budget-branches" class="text-navy-dark text-2xl mr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Back to Budget Branches">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-navy-dark" id="department-branch-title"></h2>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6 flex flex-col md:flex-row items-center justify-center">
                    <div class="relative w-48 h-48 md:w-64 md:h-64 mb-4 md:mb-0 md:mr-6">
                        <canvas id="department-pie-chart" class="w-full h-full"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-center">
                            <span class="text-xl font-bold text-navy-dark">Total: $<span id="branch-total-contributed">0</span></span>
                        </div>
                    </div>
                    <div class="text-center md:text-left">
                        <h3 class="text-xl font-semibold text-navy-dark mb-2">Branch Funding Status:</h3>
                        <span id="branch-funding-status" class="px-4 py-2 rounded-full text-lg font-bold"></span>
                    </div>
                </div>

                <div id="pie-chart-legend" class="bg-white rounded-xl shadow-lg p-4 mt-6">
                    <h4 class="text-lg font-semibold text-navy-dark mb-3">Legend</h4>
                    <div id="legend-items" class="space-y-2">
                        </div>
                </div>

                <h3 class="text-xl font-semibold text-navy-dark mb-4 mt-6">Departments</h3>
                <div id="departments-list" class="space-y-4">
                    </div>
            </section>

            <section id="budget-proposal-review-page" class="page hidden">
                <header class="flex items-center mb-4">
                    <button id="back-to-legislation-from-budget-proposal" class="text-navy-dark text-2xl mr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Back to Legislation list">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-navy-dark" id="budget-proposal-title"></h2>
                </header>

                <div id="budget-proposal-branches-list" class="space-y-4">
                    </div>
            </section>


            <section id="my-votes-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">My Voting History</h2>
                <div id="my-votes-list" class="space-y-4">
                    <p class="text-gray-600" id="no-votes-message">You haven't cast any votes yet.</p>
                </div>
            </section>

            <section id="my-profile-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">My Profile</h2>
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <img src="https://i.pravatar.cc/96?img=15" alt="User Avatar" class="w-24 h-24 rounded-full mr-4 border-4 border-navy-dark">
                        <div>
                            <h3 class="text-2xl font-bold text-navy-dark" id="profile-name"></h3>
                            <p class="text-gray-700 text-lg" id="profile-headline"></p>
                            <p class="text-gray-500 text-sm" id="profile-location"></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-xl font-semibold text-navy-dark mb-2">About</h4>
                        <p class="text-gray-700 leading-relaxed" id="profile-bio"></p>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-xl font-semibold text-navy-dark mb-2">Experience</h4>
                        <ul id="profile-experience" class="space-y-2"></ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-xl font-semibold text-navy-dark mb-2">Education</h4>
                        <ul id="profile-education" class="space-y-2"></ul>
                    </div>

                    <div>
                        <h4 class="text-xl font-semibold text-navy-dark mb-2">Skills</h4>
                        <div id="profile-skills" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </section>

            <section id="my-rep-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">My Representatives</h2>
                <div id="map-container" class="relative bg-white rounded-xl shadow-lg mb-6">
                    <canvas id="map-canvas"></canvas>
                    <div id="rep-info-modal" class="rep-info-modal hidden p-4 rounded-lg shadow-lg bg-white">
                        <h3 class="text-xl font-bold text-navy-dark mb-2" id="modal-rep-name"></h3>
                        <p class="text-gray-700 text-sm" id="modal-rep-office"></p>
                        <p class="text-gray-600 text-xs" id="modal-rep-party"></p>
                        <p class="text-gray-600 text-sm mt-2">Email: <a href="#" id="modal-rep-email" class="text-blue-600 hover:underline"></a></p>
                        <p class="text-gray-600 text-sm">Phone: <a href="#" id="modal-rep-phone" class="text-blue-600 hover:underline"></a></p>
                        <button id="close-modal" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 focus:outline-none" aria-label="Close representative information">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="my-reps-list" class="space-y-6">
                    </div>
            </section>

            <section id="support-page" class="page hidden">
                <h2 class="text-3xl font-bold text-navy-dark mb-6">Support</h2>
                <p class="text-gray-700">Need help? Contact us or check our FAQs.</p>
            </section>
        </main>
    </div>

    <script>
        // Tailwind CSS Configuration (for custom colors)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'navy-dark': '#1A365D',
                    }
                }
            }
        }

        // --- Mock Data ---
        const appData = {
            bills: [
                {
                    id: 'bill-001',
                    type: 'federal', // 'federal', 'state', 'county'
                    title: 'Infrastructure Modernization Act of 2025',
                    deadline: '2025-08-15',
                    participation: 72, // Percentage
                    summary: [
                        "This bipartisan bill proposes a comprehensive overhaul of national infrastructure, allocating significant federal funds to repair aging roads, bridges, and public transit systems. It aims to create thousands of jobs, stimulate local economies, and enhance connectivity across states. Key provisions include funding for high-speed rail development and expanding broadband internet access to rural areas.",
                        "The act emphasizes sustainable development practices, mandating that a portion of the funds be used for environmentally friendly projects, such as electric vehicle charging stations and renewable energy infrastructure. It also includes provisions for cybersecurity upgrades to critical infrastructure networks to protect against modern threats and ensure long-term resilience.",
                        "Critics raise concerns about the bill's total cost and potential for increased national debt, while proponents argue that the long-term economic benefits and improved quality of life for citizens outweigh the initial investment. Public input is crucial to shaping the final implementation of these widespread infrastructure improvements."
                    ],
                    fullTextLink: 'javascript:alert(\'Mock PDF link for Infrastructure Modernization Act. In a real app, this would open the bill PDF.\');',
                    officialComment: {
                        representative: 'Rep. Jane Smith',
                        stance: 'Supports this bill because it will bring much-needed jobs and economic growth to our district, ensuring our roads are safe and our communities are connected with reliable broadband. While the cost is significant, the long-term benefits for American competitiveness and quality of life are immeasurable.',
                        avatar: 'https://placehold.co/40x40/1A365D/FFFFFF?text=JS'
                    },
                    userComments: [
                        {
                            id: 'comment-101',
                            user: 'CivicVoterPro',
                            avatar: 'https://i.pravatar.cc/40?img=1',
                            text: 'Finally, a bill that addresses real issues! Our bridges are falling apart. I just hope the funds are distributed fairly.',
                            upvotes: 24,
                            downvotes: 2,
                            date: '2025-07-14T10:30:00Z'
                        },
                        {
                            id: 'comment-102',
                            user: 'TaxpayerConcerned',
                            avatar: 'https://i.pravatar.cc/40?img=2',
                            text: 'This sounds good on paper, but I worry about the cost and where all this money is truly going to end up. We need more transparency on project selection.',
                            upvotes: 15,
                            downvotes: 8,
                            date: '2025-07-14T11:45:00Z'
                        },
                        {
                            id: 'comment-103',
                            user: 'GreenFutureNow',
                            avatar: 'https://i.pravatar.cc/40?img=3',
                            text: 'Excited about the focus on sustainable infrastructure. This is a crucial step towards a greener future for our country.',
                            upvotes: 30,
                            downvotes: 1,
                            date: '2025-07-14T13:10:00Z'
                        },
                         {
                            id: 'comment-104',
                            user: 'RuralConnect',
                            avatar: 'https://i.pravatar.cc/40?img=4',
                            text: 'Broadband for rural areas is a game changer! My community has been waiting for this for years. This bill could transform lives.',
                            upvotes: 28,
                            downvotes: 0,
                            date: '2025-07-14T15:00:00Z'
                        },
                    ]
                },
                {
                    id: 'federal-budget-2026',
                    type: 'federal',
                    title: 'Proposed Federal Budget 2026',
                    deadline: '2025-09-30',
                    participation: 65,
                    isBudgetProposal: true, // Flag to identify this as a budget proposal
                    summary: [
                        "This is the proposed federal budget for Fiscal Year 2026. It outlines the government's planned spending and revenue for the upcoming year across all major federal functions, from defense to social programs. This proposal aims to balance national priorities with fiscal responsibility, addressing key challenges while ensuring sustainable growth.",
                        "Key allocations include significant investments in national security, healthcare infrastructure, and climate change initiatives. It also details funding for research and development, education, and support for small businesses. The budget reflects current administration priorities and economic forecasts.",
                        "Constituents are encouraged to review the proposed allocations and provide their input. Your feedback is crucial in shaping how public funds are utilized to best serve the nation's needs. This budget is currently under review by Congress and subject to amendments."
                    ],
                    fullTextLink: 'javascript:alert(\'Mock PDF link for Proposed Federal Budget 2026.\');',
                    officialComment: {
                        representative: 'Sen. John Doe (Budget Committee)',
                        stance: 'This budget proposal represents a balanced approach to our nation\'s needs, prioritizing economic stability and strategic investments for the future. We believe it addresses critical areas while maintaining fiscal prudence.',
                        avatar: 'https://placehold.co/40x40/1A365D/FFFFFF?text=JD'
                    },
                    userComments: [
                        { id: 'comment-b1', user: 'FiscalHawk', avatar: 'https://i.pravatar.cc/40?img=13', text: 'Concerned about the deficit. We need more cuts, not more spending, even in vital areas.', upvotes: 10, downvotes: 5, date: '2025-09-01T09:00:00Z' },
                        { id: 'comment-b2', user: 'ProgressiveVoice', avatar: 'https://i.pravatar.cc/40?img=14', text: 'More funding needed for social safety nets and renewable energy. This budget doesn\'t go far enough.', upvotes: 12, downvotes: 3, date: '2025-09-02T11:00:00Z' }
                    ]
                },
                {
                    id: 'bill-002',
                    type: 'state',
                    title: 'State Education Reform Bill (HB 105)',
                    deadline: '2025-08-20',
                    participation: 55,
                    summary: [
                        "This state-level bill aims to modernize our public education system by implementing new curriculum standards focused on STEM and vocational training. It proposes increased funding for teacher salaries and professional development programs, seeking to attract and retain top talent in our schools. The bill also includes provisions for expanded access to early childhood education programs across the state.",
                        "A key component is the establishment of a statewide digital learning platform, providing equitable access to educational resources for all students, regardless of their geographical location. This initiative is designed to bridge the digital divide and prepare students for the demands of a rapidly evolving job market. The bill emphasizes accountability measures for school performance.",
                        "Debate around the bill centers on funding mechanisms and the balance between state-mandated curriculum and local school district autonomy. Supporters highlight the potential for improved student outcomes and a more competitive workforce, while some critics express concerns about standardized testing and potential impacts on smaller, rural districts."
                    ],
                    fullTextLink: 'javascript:alert(\'Mock PDF link for State Education Reform Bill.\');',
                    officialComment: {
                        representative: 'State Sen. David Lee',
                        stance: 'Strongly supports improving our state\'s public education system by investing in our teachers and providing modern learning tools. This bill is a crucial step towards ensuring every child has access to a high-quality education, preparing them for future success.',
                        avatar: 'https://placehold.co/40x40/1A365D/FFFFFF?text=DL'
                    },
                    userComments: [
                        { id: 'comment-201', user: 'EducatorVoice', avatar: 'https://i.pravatar.cc/40?img=5', text: 'Increased teacher pay is long overdue! This will help keep great educators in our schools.', upvotes: 18, downvotes: 1, date: '2025-07-13T09:00:00Z' },
                        { id: 'comment-202', user: 'ParentAdvocate', avatar: 'https://i.pravatar.cc/40?img=6', text: 'Worried about the focus on STEM over arts. A balanced education is important for holistic development.', upvotes: 10, downvotes: 5, date: '2025-07-13T14:00:00Z' }
                    ]
                },
                {
                    id: 'bill-003',
                    type: 'county',
                    title: 'County Park Development Initiative',
                    deadline: '2025-09-01',
                    participation: 30,
                    summary: [
                        "This county-level initiative proposes the acquisition of new land for the development of several community parks and green spaces. The plan includes the construction of walking trails, playgrounds, and picnic areas, aiming to enhance recreational opportunities for residents of all ages. It also allocates funds for the revitalization of existing, underutilized park facilities.",
                        "The initiative emphasizes ecological preservation, with provisions for native plant restoration and stormwater management solutions within the new park designs. Community input sessions have been held to gather feedback on desired amenities and design elements, ensuring the parks meet the specific needs and preferences of local neighborhoods.",
                        "Funding for the project will come from a combination of county bonds and state grants. While widely supported for its health and community benefits, some discussions have arisen regarding the optimal locations for new parks and the long-term maintenance costs. The goal is to create accessible, vibrant public spaces that foster community well-being."
                    ],
                    fullTextLink: 'javascript:alert(\'Mock PDF link for County Park Development Initiative.\');',
                    officialComment: {
                        representative: 'County Commissioner Ana Rodriguez',
                        stance: 'This initiative will create much-needed green spaces and recreational opportunities for our families. Investing in our parks is investing in the health and happiness of our community, and I\'m proud to support it.',
                        avatar: 'https://placehold.co/40x40/1A365D/FFFFFF?text=AR'
                    },
                    userComments: [
                        { id: 'comment-301', user: 'LocalRunner', avatar: 'https://i.pravatar.cc/40?img=7', text: 'More trails are great! Hope they connect to existing networks.', upvotes: 7, downvotes: 0, date: '2025-07-12T16:00:00Z' },
                        { id: 'comment-302', user: 'NeighborhoodWatch', avatar: 'https://i.pravatar.cc/40?img=8', text: 'Excited for new playgrounds for the kids. Maintenance needs to be a priority though.', upvotes: 5, downvotes: 1, date: '2025-07-12T18:30:00Z' }
                    ]
                },
                {
                    id: 'bill-004',
                    type: 'federal',
                    title: 'National Cybersecurity Enhancement Act',
                    deadline: '2025-09-10',
                    participation: 68,
                    summary: [
                        "This federal bill proposes significant investments in national cybersecurity infrastructure and initiatives to protect government agencies, critical industries, and citizens from cyber threats. It aims to establish new federal standards for data security, enhance information sharing between public and private sectors, and increase funding for cybersecurity research and development.",
                        "Key provisions include the creation of a national cyber workforce training program to address the shortage of skilled cybersecurity professionals and the implementation of rapid response protocols for major cyber incidents. The act also seeks to improve the resilience of essential services, such as power grids and financial systems, against sophisticated digital attacks.",
                        "The bill is a response to the growing frequency and complexity of cyberattacks targeting both government and private entities. While broadly supported for national security reasons, some privacy advocates have raised concerns about potential government access to private data and the balance between security and individual liberties. The legislation seeks to strike this balance while fortifying national defenses."
                    ],
                    fullTextLink: 'javascript:alert(\'Mock PDF link for National Cybersecurity Enhancement Act.\');',
                    officialComment: {
                        representative: 'Rep. Mark Jones',
                        stance: 'Protecting our digital infrastructure is paramount in today\'s world. This act ensures we have the resources and talent to defend against cyber threats, safeguarding our economy and national security. It\'s a vital investment in our future.',
                        avatar: 'https://placehold.co/40x40/1A365D/FFFFFF?text=MJ'
                    },
                    userComments: [
                        { id: 'comment-401', user: 'TechSavvy', avatar: 'https://i.pravatar.cc/40?img=9', text: 'Good to see cybersecurity finally getting the attention it deserves. Hope it focuses on prevention, not just reaction.', upvotes: 12, downvotes: 0, date: '2025-07-11T10:00:00Z' },
                        { id: 'comment-402', user: 'PrivacyAdvocate', avatar: 'https://i.pravatar.cc/40?img=10', text: 'Concerned about privacy implications. We need strong oversight to ensure this doesn\'t lead to mass surveillance.', upvotes: 8, downvotes: 3, date: '2025-07-11T15:00:00Z' }
                    ]
                },
                {
                    id: 'bill-005',
                    type: 'state',
                    title: 'Clean Water Infrastructure Bill (SB 210)',
                    deadline: '2025-09-25',
                    participation: 48,
                    summary: [
                        "This state bill aims to improve the quality and accessibility of clean drinking water across the state by upgrading aging water treatment facilities and replacing lead pipes. It proposes a significant allocation of state funds and encourages partnerships with local municipalities to implement these crucial infrastructure projects.",
                        "The legislation also includes provisions for protecting natural water sources from pollution through stricter environmental regulations and increased monitoring. It emphasizes public health, aiming to reduce waterborne illnesses and ensure that all communities, particularly underserved areas, have reliable access to safe and clean water.",
                        "While the bill has broad support due to its direct impact on public health, discussions revolve around the financing mechanisms and the timeline for project completion. Proponents argue that the long-term health benefits and economic stability provided by clean water far outweigh the investment, making it a critical piece of legislation for the state\'s future."
                    ],
                    fullTextLink: 'javascript:alert(\'Mock PDF link for Clean Water Infrastructure Bill.\');',
                    officialComment: {
                        representative: 'State Rep. Emily Chen',
                        stance: 'Ensuring access to clean, safe drinking water is a basic right for all citizens. This bill makes vital investments in our water infrastructure, protecting public health and securing a sustainable future for our communities.',
                        avatar: 'https://placehold.co/40x40/1A365D/FFFFFF?text=EC'
                    },
                    userComments: [
                        { id: 'comment-501', user: 'CommunityHealth', avatar: 'https://i.pravatar.cc/40?img=11', text: 'Replacing lead pipes is essential! This will make a huge difference for families.', upvotes: 15, downvotes: 0, date: '2025-07-10T08:00:00Z' },
                        { id: 'comment-502', user: 'RuralResident', avatar: 'https://i.pravatar.cc/40?img=12', text: 'Hope this reaches smaller towns too, not just the big cities. We need clean water just as much.', upvotes: 10, downvotes: 2, date: '2025-07-10T12:00:00Z' }
                    ]
                }
            ],

            newsFeed: [
                {
                    id: 'news-001',
                    type: 'Federal Update',
                    title: 'President Signs Infrastructure Modernization Act',
                    date: '2025-08-16',
                    content: 'Following widespread public support, the Infrastructure Modernization Act of 2025 has been signed into law. This landmark legislation is expected to kickstart thousands of projects nationwide, focusing on roads, bridges, and broadband expansion. Local communities are encouraged to look out for grant application details in the coming weeks.',
                    office: 'Federal Government'
                },
                {
                    id: 'news-002',
                    type: 'State Announcement',
                    title: 'New State Education Standards Approved',
                    date: '2025-08-21',
                    content: 'The State Education Reform Bill (HB 105) has officially passed and will introduce new curriculum standards, increased teacher salaries, and expanded early childhood education programs. Implementation will begin in the next academic year. Public forums will be held to discuss the transition.',
                    office: 'State Legislature'
                },
                {
                    id: 'news-003',
                    type: 'County Project',
                    title: 'Groundbreaking for New Central Park Expansion',
                    date: '2025-09-05',
                    content: 'The County Park Development Initiative is moving forward with a groundbreaking ceremony scheduled for next month at the site of the new Central Park expansion. This project will add new trails, playgrounds, and green spaces for residents. Volunteers are welcome for upcoming community planting events.',
                    office: 'County Government'
                }
            ],

            userVotes: [
                { billId: 'bill-001', vote: 'yes', date: '2025-08-10' },
                { billId: 'bill-002', vote: 'yes', date: '2025-08-18' },
                { billId: 'bill-004', vote: 'no', date: '2025-09-01' }, // Example of a 'no' vote
            ],

            userProfile: {
                name: 'Alex Johnson',
                headline: 'Engaged Citizen | Community Advocate | Tech Enthusiast',
                location: 'Austin, TX',
                bio: 'Passionate about civic engagement and leveraging technology for democratic participation. I believe in informed voting and direct communication with elected officials to build stronger communities. Always looking for ways to make a positive impact.',
                experience: [
                    { title: 'Community Organizer', company: 'Local Civic Group', years: '2022 - Present', description: 'Led initiatives for voter registration, local policy awareness, and community clean-up drives. Successfully increased local voter turnout by 15% in the last election cycle.' },
                    { title: 'Software Developer', company: 'Tech Solutions Inc.', years: '2018 - 2022', description: 'Developed mobile applications focusing on user experience and data privacy for various clients. Specialized in secure data handling and intuitive UI design.' }
                ],
                education: [
                    { degree: 'M.S. Computer Science', institution: 'State University, Anytown, USA', years: '2016 - 2018' },
                    { degree: 'B.A. Political Science', institution: 'City College, Anytown, USA', years: '2012 - 2016' }
                ],
                skills: ['Civic Engagement', 'Policy Analysis', 'Mobile Development', 'Community Outreach', 'Data Privacy', 'Public Speaking', 'Project Management', 'UI/UX Design', 'JavaScript', 'HTML/CSS']
            },

            representatives: [
                {
                    id: 'rep-federal',
                    office: 'U.S. House of Representatives',
                    name: 'Jane Smith',
                    party: 'Independent',
                    contact: 'contact.jsmith@house.gov',
                    phone: '(202) 555-0101',
                    district: '12th Congressional District',
                    avatar: 'https://placehold.co/60x60/1A365D/FFFFFF?text=JS',
                    mapCoords: { lat: 34.0522, lon: -118.2437, city: 'Los Angeles' } // Mock coords for a US city
                },
                {
                    id: 'rep-state-senate',
                    office: 'State Senate',
                    name: 'David Lee',
                    party: 'Democrat',
                    contact: 'dlee@state.gov',
                    phone: '(512) 555-0202',
                    district: 'State District 45',
                    avatar: 'https://placehold.co/60x60/1A365D/FFFFFF?text=DL',
                    mapCoords: { lat: 30.2672, lon: -97.7431, city: 'Austin' } // Mock coords for a US city
                },
                {
                    id: 'rep-county-commissioner',
                    office: 'County Commissioner',
                    name: 'Ana Rodriguez',
                    party: 'Republican',
                    contact: 'arodriguez@county.gov',
                    phone: '(737) 555-0303',
                    district: 'County Precinct 3',
                    avatar: 'https://placehold.co/60x60/1A365D/FFFFFF?text=AR',
                    mapCoords: { lat: 29.7604, lon: -95.3698, city: 'Houston' } // Mock coords for a US city
                },
                {
                    id: 'rep-mayor',
                    office: 'Mayor',
                    name: 'Michael Brown',
                    party: 'Non-Partisan',
                    contact: 'mayor@city.gov',
                    phone: '(512) 555-0404',
                    district: 'City of Austin',
                    avatar: 'https://placehold.co/60x60/1A365D/FFFFFF?text=MB',
                    mapCoords: { lat: 30.2672, lon: -97.7431, city: 'Austin' } // Mock coords for a US city
                }
            ],

            budgets: [
                {
                    id: 'travis-county-budget',
                    type: 'county',
                    name: 'Travis County Budget',
                    totalBudget: 1500000000, // $1.5 Billion
                    appConstituents: 10000, // Mock number of app users in this county
                    branches: [
                        {
                            id: 'public-safety',
                            name: 'Public Safety',
                            criticalFunding: 300000000, // $300M
                            optimalFunding: 400000000, // $400M
                            proposedBudget: 380000000, // For budget proposal comparison
                            departments: [
                                { id: 'sheriff-dept', name: 'Sheriff\'s Department', proposedBudget: 200000000, criticalFunding: 180000000, optimalFunding: 220000000 },
                                { id: 'fire-ems', name: 'Fire & EMS', proposedBudget: 100000000, criticalFunding: 90000000, optimalFunding: 110000000 },
                                { id: 'judicial-services', name: 'Judicial Services', proposedBudget: 50000000, criticalFunding: 45000000, optimalFunding: 55000000 },
                                { id: 'emergency-mgmt', name: 'Emergency Management', proposedBudget: 30000000, criticalFunding: 25000000, optimalFunding: 35000000 }
                            ]
                        },
                        {
                            id: 'transportation',
                            name: 'Transportation',
                            criticalFunding: 150000000,
                            optimalFunding: 200000000,
                            proposedBudget: 180000000, // For budget proposal comparison
                            departments: [
                                { id: 'roads-bridges', name: 'Roads & Bridges', proposedBudget: 120000000, criticalFunding: 100000000, optimalFunding: 130000000 },
                                { id: 'public-transit', name: 'Public Transit', proposedBudget: 60000000, criticalFunding: 50000000, optimalFunding: 70000000 },
                            ]
                        },
                        { id: 'education', name: 'Education', criticalFunding: 200000000, optimalFunding: 250000000, proposedBudget: 230000000, departments: [] },
                        { id: 'health-human-services', name: 'Health & Human Services', criticalFunding: 180000000, optimalFunding: 220000000, proposedBudget: 210000000, departments: [] },
                        { id: 'parks-recreation', name: 'Parks & Recreation', criticalFunding: 80000000, optimalFunding: 100000000, proposedBudget: 90000000, departments: [] },
                        { id: 'environmental-protection', name: 'Environmental Protection', criticalFunding: 50000000, optimalFunding: 70000000, proposedBudget: 60000000, departments: [] },
                        { id: 'economic-development', name: 'Economic Development', criticalFunding: 70000000, optimalFunding: 90000000, proposedBudget: 80000000, departments: [] },
                        { id: 'housing-community', name: 'Housing & Community Affairs', criticalFunding: 100000000, optimalFunding: 130000000, proposedBudget: 110000000, departments: [] },
                        { id: 'general-admin', name: 'General Administration', criticalFunding: 60000000, optimalFunding: 80000000, proposedBudget: 70000000, departments: [] },
                        { id: 'public-works', name: 'Public Works', criticalFunding: 90000000, optimalFunding: 120000000, proposedBudget: 100000000, departments: [] },
                        { id: 'libraries-culture', name: 'Libraries & Culture', criticalFunding: 30000000, optimalFunding: 40000000, proposedBudget: 35000000, departments: [] },
                        { id: 'technology-innovation', name: 'Technology & Innovation', criticalFunding: 20000000, optimalFunding: 30000000, proposedBudget: 25000000, departments: [] }
                    ]
                },
                {
                    id: 'state-budget-2026',
                    type: 'state',
                    name: 'State of Texas Budget 2026',
                    totalBudget: 200000000000, // $200 Billion
                    appConstituents: 500000,
                    branches: [] // Not detailed for mock
                },
                {
                    id: 'federal-budget-2025',
                    type: 'federal',
                    name: 'Federal Budget 2025',
                    totalBudget: 6000000000000, // $6 Trillion
                    appConstituents: 1000000,
                    branches: [] // Not detailed for mock
                }
            ]
        };

        // --- User-specific data (loaded from localStorage) ---
        // Initialize userBudgetContributions from localStorage or as empty object
        let userBudgetContributions = JSON.parse(localStorage.getItem('userBudgetContributions')) || {
            'travis-county-budget': {
                'public-safety': {
                    total: 10000, // Example contribution to the branch as a whole
                    departments: {
                        'sheriff-dept': 5000,
                        'fire-ems': 3000,
                        'judicial-services': 1000,
                        'emergency-mgmt': 500
                    }
                },
                'transportation': {
                    total: 0,
                    departments: {
                        'roads-bridges': 2000,
                        'public-transit': 1000
                    }
                },
                'education': { total: 0, departments: {} },
                'health-human-services': { total: 0, departments: {} },
                'parks-recreation': { total: 0, departments: {} },
                'environmental-protection': { total: 0, departments: {} },
                'economic-development': { total: 0, departments: {} },
                'housing-community': { total: 0, departments: {} },
                'general-admin': { total: 0, departments: {} },
                'public-works': { total: 0, departments: {} },
                'libraries-culture': { total: 0, departments: {} },
                'technology-innovation': { total: 0, departments: {} }
            }
        };

        // Calculate initial wallet amount based on mock data
        function calculateInitialWallet() {
            const budgetId = 'travis-county-budget'; // The budget we are detailing
            const budget = appData.budgets.find(b => b.id === budgetId);
            if (!budget) return 0;

            const totalBudget = budget.totalBudget;
            const appConstituents = budget.appConstituents;
            const perConstituentShare = totalBudget / appConstituents;

            // Sum up all contributions made by the user for this budget
            let contributedAmount = 0;
            if (userBudgetContributions[budgetId]) {
                for (const branchId in userBudgetContributions[budgetId]) {
                    // Sum direct branch contributions
                    contributedAmount += userBudgetContributions[budgetId][branchId].total || 0;
                    // Sum department contributions within the branch
                    if (userBudgetContributions[budgetId][branchId].departments) {
                        for (const deptId in userBudgetContributions[budgetId][branchId].departments) {
                            contributedAmount += userBudgetContributions[budgetId][branchId].departments[deptId] || 0;
                        }
                    }
                }
            }
            return Math.max(0, perConstituentShare - contributedAmount); // Wallet cannot be negative
        }

        let walletAmount = calculateInitialWallet();


        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const mainContent = document.getElementById('main-content');
        const openSidebarBtn = document.getElementById('open-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');

        const homePage = document.getElementById('home-page');
        const newsFeedList = document.getElementById('news-feed-list');

        const legislationPage = document.getElementById('legislation-page');
        const billDetailPage = document.getElementById('bill-detail-page');
        const swipeBillContainer = document.getElementById('swipe-bill-container');
        const swipeBillCard = document.getElementById('swipe-bill-card');
        const swipeBillTitle = document.getElementById('swipe-bill-title');
        const swipeBillDeadline = document.getElementById('swipe-bill-deadline');
        const swipeBillParticipation = document.getElementById('swipe-bill-participation');
        const swipeBillType = document.getElementById('swipe-bill-type');
        const swipeBillVotedStatus = document.getElementById('swipe-bill-voted-status');
        const swipeBillVoteYesIndicator = document.getElementById('swipe-bill-vote-yes');
        const swipeBillVoteNoIndicator = document.getElementById('swipe-bill-vote-no');
        const otherBillsList = document.getElementById('other-bills-list');

        const detailBillTitle = document.getElementById('detail-bill-title');
        const detailBillSummary = document.getElementById('detail-bill-summary');
        const viewPdfButton = document.getElementById('view-pdf-button');
        const officialCommentDiv = document.getElementById('official-comment');
        const officialAvatar = document.getElementById('official-avatar');
        const officialName = document.getElementById('official-name');
        const officialStance = document.getElementById('official-stance');
        const userCommentsList = document.getElementById('user-comments-list');
        const backToLegislationBtn = document.getElementById('back-to-legislation');

        const budgetsList = document.getElementById('budgets-list');
        const budgetDetailPage = document.getElementById('budget-detail-page');
        const backToBudgetsBtn = document.getElementById('back-to-budgets');
        const budgetDetailTitle = document.getElementById('budget-detail-title');
        const walletAmountSpan = document.getElementById('wallet-amount');
        const budgetBranchesList = document.getElementById('budget-branches-list');

        const departmentDetailPage = document.getElementById('department-detail-page');
        const backToBudgetBranchesBtn = document.getElementById('back-to-budget-branches');
        const departmentBranchTitle = document.getElementById('department-branch-title');
        const departmentPieChart = document.getElementById('department-pie-chart');
        let departmentPieChartInstance = null; // To hold the Chart.js instance
        const branchTotalContributedSpan = document.getElementById('branch-total-contributed');
        const branchFundingStatusSpan = document.getElementById('branch-funding-status');
        const departmentsList = document.getElementById('departments-list');
        const pieChartLegend = document.getElementById('pie-chart-legend');
        const legendItemsContainer = document.getElementById('legend-items');


        const budgetProposalReviewPage = document.getElementById('budget-proposal-review-page');
        const backToLegislationFromBudgetProposalBtn = document.getElementById('back-to-legislation-from-budget-proposal');
        const budgetProposalTitle = document.getElementById('budget-proposal-title');
        const budgetProposalBranchesList = document.getElementById('budget-proposal-branches-list');


        const myVotesList = document.getElementById('my-votes-list');
        const noVotesMessage = document.getElementById('no-votes-message');

        const profileName = document.getElementById('profile-name');
        const profileHeadline = document.getElementById('profile-headline');
        const profileLocation = document.getElementById('profile-location');
        const profileBio = document.getElementById('profile-bio');
        const profileExperience = document.getElementById('profile-experience');
        const profileEducation = document.getElementById('profile-education');
        const profileSkills = document.getElementById('profile-skills');

        const myRepsList = document.getElementById('my-reps-list');
        const mapCanvas = document.getElementById('map-canvas');
        const repInfoModal = document.getElementById('rep-info-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalRepName = document.getElementById('modal-rep-name');
        const modalRepOffice = document.getElementById('modal-rep-office');
        const modalRepParty = document.getElementById('modal-rep-party');
        const modalRepEmail = document.getElementById('modal-rep-email');
        const modalRepPhone = document.getElementById('modal-rep-phone');

        // --- Three.js Global Variables for Map ---
        let scene, camera, renderer;
        let mapPlane;
        const pins = [];
        let raycaster, mouse;
        let isMapDragging = false;
        let previousTouchDistance = 0;
        let lastPanPosition = { x: 0, y: 0 };
        const MAP_WIDTH = 100;
        const MAP_HEIGHT = 60; // Aspect ratio for a rough US shape

        // --- State Variables ---
        let currentBillId = null;
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        const swipeThreshold = 0.3; // 30% of card width for a vote

        let currentBudgetId = null;
        let currentBudgetBranchId = null;

        // --- Helper Functions ---
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
        }

        function getFundingStatus(current, critical, optimal) {
            if (current < critical) {
                return { status: 'Critically Underfunded', class: 'funding-red', textClass: 'text-funding-red', borderClass: 'border-funding-red' };
            } else if (current < optimal) {
                return { status: 'Under Optimal Goal', class: 'funding-yellow', textClass: 'text-funding-yellow', borderClass: 'border-funding-yellow' };
            } else if (current >= optimal && current < optimal * 1.1) { // Within 10% of optimal
                return { status: 'Near Optimal Goal', class: 'funding-green', textClass: 'text-funding-green', borderClass: 'border-funding-green' };
            } else {
                return { status: 'Overfunded', class: 'funding-blue', textClass: 'text-funding-blue', borderClass: 'border-funding-blue' };
            }
        }

        // Function to show a specific page and hide others
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            // Close sidebar if open
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            mainContent.classList.remove('shifted');

            // Render content for specific pages when shown
            if (pageId === 'home') {
                renderHomePage();
            } else if (pageId === 'legislation') {
                renderLegislationList();
            } else if (pageId === 'budget') {
                renderBudgetsList();
            } else if (pageId === 'my-votes') {
                renderMyVotesPage();
            } else if (pageId === 'my-profile') {
                renderMyProfilePage();
            } else if (pageId === 'my-rep') {
                renderMyRepPage();
            }
        }

        // Function to render the Home page news feed
        function renderHomePage() {
            newsFeedList.innerHTML = ''; // Clear previous news items
            appData.newsFeed.forEach(newsItem => {
                const newsCard = document.createElement('div');
                newsCard.className = 'bg-white rounded-xl shadow-md p-4';
                newsCard.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white" style="background-color: #1A365D;">${newsItem.type}</span>
                        <span class="text-sm text-gray-500 ml-auto">${new Date(newsItem.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                    </div>
                    <h3 class="text-lg font-semibold text-navy-dark mb-2">${newsItem.title}</h3>
                    <p class="text-gray-700 text-sm">${newsItem.content}</p>
                    <p class="text-gray-500 text-xs mt-2">Source: ${newsItem.office}</p>
                `;
                newsFeedList.appendChild(newsCard);
            });
        }

        // Function to render the legislation list
        function renderLegislationList() {
            // Render the first (swipeable) bill
            const firstBill = appData.bills[0];
            swipeBillTitle.textContent = firstBill.title;
            swipeBillDeadline.textContent = new Date(firstBill.deadline).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            swipeBillParticipation.textContent = firstBill.participation;
            swipeBillType.textContent = firstBill.type.charAt(0).toUpperCase() + firstBill.type.slice(1);
            swipeBillType.className = `text-xs font-semibold px-2 py-1 rounded-full text-white`; // Reset class for type
            
            // Apply specific background colors for the type badges
            if (firstBill.type === 'federal') {
                swipeBillType.style.backgroundColor = '#EF4444'; // Red
            } else if (firstBill.type === 'state') {
                swipeBillType.style.backgroundColor = '#F59E0B'; // Orange
            } else if (firstBill.type === 'county') {
                swipeBillType.style.backgroundColor = '#10B981'; // Green
            }

            // Check localStorage for vote status
            const voteStatus = localStorage.getItem(`vote_${firstBill.id}`);
            if (voteStatus) {
                swipeBillCard.classList.add('locked');
                swipeBillVotedStatus.classList.remove('hidden');
                swipeBillVotedStatus.textContent = `You Voted: ${voteStatus.toUpperCase()}`;
                if (voteStatus === 'yes') {
                    swipeBillVotedStatus.classList.add('text-green-600');
                    swipeBillVotedStatus.classList.remove('text-red-600');
                } else {
                    swipeBillVotedStatus.classList.add('text-red-600');
                    swipeBillVotedStatus.classList.remove('text-green-600');
                }
            } else {
                swipeBillCard.classList.remove('locked');
                swipeBillVotedStatus.classList.add('hidden');
                swipeBillVotedStatus.textContent = '';
                resetSwipeCard(); // Ensure it's reset if not voted
            }

            // Render other bills
            otherBillsList.innerHTML = ''; // Clear previous bills
            appData.bills.slice(1).forEach(bill => {
                const billCard = document.createElement('div');
                billCard.className = `bg-white rounded-xl shadow-md p-4 border-l-4 cursor-pointer hover:shadow-lg transition-shadow duration-200`;
                billCard.setAttribute('role', 'button');
                billCard.setAttribute('aria-label', `View details for ${bill.title}`);
                billCard.dataset.billId = bill.id;
                
                // Apply specific border-left-color for other bills
                if (bill.type === 'federal') {
                    billCard.classList.add('federal-bill');
                } else if (bill.type === 'state') {
                    billCard.classList.add('state-bill');
                } else if (bill.type === 'county') {
                    billCard.classList.add('county-bill');
                }

                billCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-navy-dark mb-1">${bill.title}</h3>
                    <p class="text-sm text-gray-500 mb-2">Voting ends: ${new Date(bill.deadline).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                    <div class="flex items-center justify-between text-gray-600">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white" style="background-color: ${bill.type === 'federal' ? '#EF4444' : (bill.type === 'state' ? '#F59E0B' : '#10B981')}">${bill.type.charAt(0).toUpperCase() + bill.type.slice(1)}</span>
                    </div>
                `;
                if (bill.isBudgetProposal) {
                    billCard.addEventListener('click', () => showBudgetProposalReview(bill.id));
                } else {
                    billCard.addEventListener('click', () => showBillDetail(bill.id));
                }
                otherBillsList.appendChild(billCard);
            });
        }

        // Function to render the bill detail page
        function showBillDetail(billId) {
            const bill = appData.bills.find(b => b.id === billId);
            if (!bill) return;

            currentBillId = billId;
            detailBillTitle.textContent = bill.title;

            // Summary
            detailBillSummary.innerHTML = bill.summary.map(p => `<p>${p}</p>`).join('');

            // PDF Link
            viewPdfButton.onclick = () => {
                eval(bill.fullTextLink); // Execute the mock JS alert
            };

            // Official Comment
            officialAvatar.src = bill.officialComment.avatar;
            officialAvatar.alt = `${bill.officialComment.representative}'s Avatar`;
            officialName.textContent = bill.officialComment.representative;
            officialStance.textContent = bill.officialComment.stance;

            // User Comments
            userCommentsList.innerHTML = ''; // Clear previous comments
            bill.userComments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                commentDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <img src="${comment.avatar}" alt="${comment.user}'s Avatar" class="w-8 h-8 rounded-full mr-3">
                        <span class="font-semibold text-navy-dark">${comment.user}</span>
                        <span class="text-xs text-gray-400 ml-auto">${new Date(comment.date).toLocaleDateString()}</span>
                    </div>
                    <p class="text-gray-700 mb-3">${comment.text}</p>
                    <div class="flex items-center text-gray-500 text-sm">
                        <button class="flex items-center mr-4 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Upvote comment"><i class="fas fa-thumbs-up mr-1"></i> ${comment.upvotes}</button>
                        <button class="flex items-center hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" aria-label="Downvote comment"><i class="fas fa-thumbs-down mr-1"></i> ${comment.downvotes}</button>
                    </div>
                `;
                userCommentsList.appendChild(commentDiv);
            });

            showPage('bill-detail');
        }

        // Function to render the Budgets list
        function renderBudgetsList() {
            budgetsList.innerHTML = '';
            appData.budgets.forEach((budget, index) => {
                const budgetCard = document.createElement('div');
                budgetCard.className = `bg-white rounded-xl shadow-md p-4 border-l-4 cursor-pointer hover:shadow-lg transition-shadow duration-200`;
                budgetCard.setAttribute('role', 'button');
                budgetCard.setAttribute('aria-label', `View details for ${budget.name}`);
                budgetCard.dataset.budgetId = budget.id;

                // Apply specific border-left-color
                if (budget.type === 'federal') {
                    budgetCard.classList.add('federal-bill');
                } else if (budget.type === 'state') {
                    budgetCard.classList.add('state-bill');
                } else if (budget.type === 'county') {
                    budgetCard.classList.add('county-bill');
                }

                budgetCard.innerHTML = `
                    <h3 class="text-lg font-semibold text-navy-dark mb-1">${budget.name}</h3>
                    <p class="text-sm text-gray-500 mb-2">Total Budget: ${formatCurrency(budget.totalBudget)}</p>
                    <div class="flex items-center justify-between text-gray-600">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white" style="background-color: ${budget.type === 'federal' ? '#EF4444' : (budget.type === 'state' ? '#F59E0B' : '#10B981')}">${budget.type.charAt(0).toUpperCase() + budget.type.slice(1)}</span>
                    </div>
                `;
                if (index === 0) { // Only make the top budget clickable for now
                    budgetCard.addEventListener('click', () => showBudgetDetail(budget.id));
                } else {
                    budgetCard.style.cursor = 'default';
                    budgetCard.classList.remove('hover:shadow-lg');
                }
                budgetsList.appendChild(budgetCard);
            });
        }

        // Function to render the Budget Detail page (branches)
        function showBudgetDetail(budgetId) {
            currentBudgetId = budgetId;
            const budget = appData.budgets.find(b => b.id === budgetId);
            if (!budget) return;

            budgetDetailTitle.textContent = budget.name;
            walletAmountSpan.textContent = formatCurrency(walletAmount).replace('$', ''); // Remove $ for span

            budgetBranchesList.innerHTML = '';
            budget.branches.forEach(branch => {
                const branchContributions = (userBudgetContributions[budgetId] && userBudgetContributions[budgetId][branch.id] && userBudgetContributions[budgetId][branch.id].total) || 0;
                const fundingStatus = getFundingStatus(branchContributions, branch.criticalFunding, branch.optimalFunding);

                const branchDiv = document.createElement('div');
                branchDiv.className = `bg-white rounded-xl shadow-md p-4 mb-4 border-l-4 ${fundingStatus.borderClass}`;
                branchDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-navy-dark">${branch.name}</h3>
                        <span class="text-sm font-medium ${fundingStatus.textClass}">${fundingStatus.status}</span>
                    </div>
                    <p class="text-gray-700 text-sm mt-1">Contributed: ${formatCurrency(branchContributions)}</p>
                    <div class="flex items-center mt-3">
                        <input type="number" min="0" max="${walletAmount}" value="0" step="1" class="w-24 p-2 border rounded-md text-sm text-gray-800" id="contribute-input-${branch.id}" aria-label="Amount to contribute to ${branch.name}">
                        <button class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" data-branch-id="${branch.id}" data-type="branch" aria-label="Contribute to ${branch.name}">Contribute</button>
                        <button class="ml-auto text-blue-600 hover:underline text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" data-branch-id="${branch.id}" aria-label="View details for ${branch.name}">View Details</button>
                    </div>
                `;
                budgetBranchesList.appendChild(branchDiv);

                // Add event listener for the "Contribute" button
                const contributeButton = branchDiv.querySelector(`button[data-branch-id="${branch.id}"][data-type="branch"]`);
                contributeButton.addEventListener('click', handleContribution);

                // Add event listener for "View Details" button (only for the first branch for mock)
                const viewDetailsButton = branchDiv.querySelector(`button[data-branch-id="${branch.id}"]:not([data-type="branch"])`);
                if (branch.id === 'public-safety') { // Only Public Safety is clickable for now
                    viewDetailsButton.addEventListener('click', () => showDepartmentDetail(budgetId, branch.id));
                } else {
                    viewDetailsButton.classList.add('hidden'); // Hide for other branches
                }
            });
            showPage('budget-detail');
        }

        // Function to handle contributions
        function handleContribution(event) {
            const branchId = event.target.dataset.branchId;
            const type = event.target.dataset.type; // 'branch' or 'department'
            const inputElement = document.getElementById(`contribute-input-${event.target.dataset.departmentId || branchId}`); // Use departmentId if available, else branchId
            const amount = parseFloat(inputElement.value);

            if (isNaN(amount) || amount <= 0 || amount > walletAmount) {
                alert('Please enter a valid amount within your wallet balance.');
                return;
            }

            // Deduct from wallet
            walletAmount -= amount;

            // Update userBudgetContributions
            if (!userBudgetContributions[currentBudgetId]) {
                userBudgetContributions[currentBudgetId] = {};
            }

            if (type === 'branch') {
                if (!userBudgetContributions[currentBudgetId][branchId]) {
                    userBudgetContributions[currentBudgetId][branchId] = { total: 0, departments: {} };
                }
                userBudgetContributions[currentBudgetId][branchId].total += amount;
            } else if (type === 'department') {
                const departmentId = event.target.dataset.departmentId;
                if (!userBudgetContributions[currentBudgetId][currentBudgetBranchId]) {
                    userBudgetContributions[currentBudgetId][currentBudgetBranchId] = { total: 0, departments: {} };
                }
                if (!userBudgetContributions[currentBudgetId][currentBudgetBranchId].departments) {
                    userBudgetContributions[currentBudgetId][currentBudgetBranchId].departments = {};
                }
                userBudgetContributions[currentBudgetId][currentBudgetBranchId].departments[departmentId] = (userBudgetContributions[currentBudgetId][currentBudgetBranchId].departments[departmentId] || 0) + amount;
            }

            localStorage.setItem('userBudgetContributions', JSON.stringify(userBudgetContributions));

            // Re-render the current page to reflect changes
            if (type === 'branch') {
                showBudgetDetail(currentBudgetId);
            } else if (type === 'department') {
                showDepartmentDetail(currentBudgetId, currentBudgetBranchId);
            }
        }

        // Color palette for pie chart, aligned with Tailwind aesthetics
        const pieChartColorPalette = [
            '#38bdf8', // sky-400
            '#60a5fa', // blue-400
            '#8b5cf6', // violet-500
            '#a855f7', // purple-500
            '#e74694', // pink-500
            '#f59e0b', // amber-500
            '#d97706', // orange-600
            '#34d399', // emerald-400
            '#10b981', // green-500
            '#ef4444', // red-500
            '#fbbf24', // yellow-400
            '#9ca3af', // gray-400 (for general funds or lesser categories)
            '#6b7280', // gray-500
            '#4b5563', // gray-600
        ];

        function generatePieChartColors(numColors) {
            const colors = [];
            for (let i = 0; i < numColors; i++) {
                colors.push(pieChartColorPalette[i % pieChartColorPalette.length]);
            }
            return colors;
        }

        // Function to render Department Detail page
        function showDepartmentDetail(budgetId, branchId) {
            currentBudgetId = budgetId;
            currentBudgetBranchId = branchId;
            const budget = appData.budgets.find(b => b.id === budgetId);
            const branch = budget ? budget.branches.find(br => br.id === branchId) : null;
            if (!budget || !branch) return;

            departmentBranchTitle.textContent = `${branch.name} Departments`;
            walletAmountSpan.textContent = formatCurrency(walletAmount).replace('$', '');

            // Calculate total contributed to this branch for overall status
            const branchContributionsTotal = (userBudgetContributions[budgetId] && userBudgetContributions[budgetId][branchId] && userBudgetContributions[budgetId][branchId].total) || 0;
            const branchDepartmentsContributions = (userBudgetContributions[budgetId] && userBudgetContributions[budgetId][branchId] && userBudgetContributions[budgetId][branchId].departments) || {};
            let totalDeptContributions = 0;
            for (const deptId in branchDepartmentsContributions) {
                totalDeptContributions += branchDepartmentsContributions[deptId];
            }
            const overallBranchContributed = branchContributionsTotal + totalDeptContributions;

            branchTotalContributedSpan.textContent = formatCurrency(overallBranchContributed).replace('$', '');
            const fundingStatus = getFundingStatus(overallBranchContributed, branch.criticalFunding, branch.optimalFunding);
            branchFundingStatusSpan.textContent = fundingStatus.status;
            branchFundingStatusSpan.className = `px-4 py-2 rounded-full text-lg font-bold ${fundingStatus.class}`;


            // Render Departments list
            departmentsList.innerHTML = '';
            let pieChartLabels = [];
            let pieChartValues = [];
            
            branch.departments.forEach(dept => {
                const deptContributed = branchDepartmentsContributions[dept.id] || 0;
                // Only add departments with contributions to the pie chart and list
                // For the list, always show
                
                pieChartLabels.push(dept.name);
                pieChartValues.push(deptContributed);

                const deptDiv = document.createElement('div');
                deptDiv.className = 'bg-white rounded-xl shadow-md p-4 mb-4';
                deptDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-navy-dark">${dept.name}</h3>
                    <p class="text-gray-700 text-sm mt-1">Contributed: ${formatCurrency(deptContributed)}</p>
                    <div class="flex items-center mt-3">
                        <input type="number" min="0" max="${walletAmount}" value="0" step="1" class="w-24 p-2 border rounded-md text-sm text-gray-800" id="contribute-input-${dept.id}" aria-label="Amount to contribute to ${dept.name}">
                        <button class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" data-branch-id="${branch.id}" data-department-id="${dept.id}" data-type="department" aria-label="Contribute to ${dept.name}">Contribute</button>
                    </div>
                `;
                departmentsList.appendChild(deptDiv);

                const contributeButton = deptDiv.querySelector(`button[data-department-id="${dept.id}"]`);
                contributeButton.addEventListener('click', handleContribution);
            });

            // Add "General Funds" to pie chart for remaining branch contributions (if any)
            if (branchContributionsTotal > 0 || pieChartValues.reduce((a, b) => a + b, 0) === 0) {
                 // Only add general funds if there's actual contribution or if no other departments have contributions
                pieChartLabels.push('General Funds');
                pieChartValues.push(branchContributionsTotal);
            }

            // Generate colors
            const pieColors = generatePieChartColors(pieChartLabels.length);

            // Destroy existing chart instance before creating a new one
            if (departmentPieChartInstance) {
                departmentPieChartInstance.destroy();
            }

            // Draw Pie Chart using Chart.js
            departmentPieChartInstance = new Chart(departmentPieChart, {
                type: 'pie',
                data: {
                    labels: pieChartLabels,
                    datasets: [{
                        data: pieChartValues,
                        backgroundColor: pieColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow flexibility in size
                    plugins: {
                        legend: {
                            display: false, // We'll create a custom legend below
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                        // Calculate percentage if total is not zero
                                        const total = pieChartValues.reduce((sum, val) => sum + val, 0);
                                        if (total > 0) {
                                            const percentage = (context.parsed / total * 100).toFixed(1);
                                            label += ` (${percentage}%)`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Render Pie Chart Custom Legend
            legendItemsContainer.innerHTML = '';
            pieChartLabels.forEach((label, index) => {
                const total = pieChartValues.reduce((sum, val) => sum + val, 0);
                const percentage = total > 0 ? (pieChartValues[index] / total * 100).toFixed(1) : 0;
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center';
                legendItem.innerHTML = `
                    <span class="w-4 h-4 rounded-full mr-2" style="background-color: ${pieColors[index]}"></span>
                    <span class="text-gray-700 text-sm">${label} (${formatCurrency(pieChartValues[index])}) - ${percentage}%</span>
                `;
                legendItemsContainer.appendChild(legendItem);
            });

            showPage('department-detail');
        }


        // Function to render Budget Proposal Review page
        function showBudgetProposalReview(billId) {
            const budgetProposalBill = appData.bills.find(b => b.id === billId && b.isBudgetProposal);
            if (!budgetProposalBill) return;

            budgetProposalTitle.textContent = budgetProposalBill.title;
            budgetProposalBranchesList.innerHTML = '';

            const detailedBudget = appData.budgets.find(b => b.id === 'travis-county-budget'); // Assuming this is the detailed budget for comparison
            if (!detailedBudget) {
                budgetProposalBranchesList.innerHTML = '<p class="text-gray-600">Detailed budget data not available for comparison.</p>';
                showPage('budget-proposal-review');
                return;
            }

            detailedBudget.branches.forEach(branch => {
                const userDesiredBranchTotal = (userBudgetContributions[detailedBudget.id] && userBudgetContributions[detailedBudget.id][branch.id] && userBudgetContributions[detailedBudget.id][branch.id].total) || 0;
                const userDesiredDepartmentsTotal = (userBudgetContributions[detailedBudget.id] && userBudgetContributions[detailedBudget.id][branch.id] && userBudgetContributions[detailedBudget.id][branch.id].departments) || {};
                let totalUserDesiredForBranch = userDesiredBranchTotal;
                for (const deptId in userDesiredDepartmentsTotal) {
                    totalUserDesiredForBranch += userDesiredDepartmentsTotal[deptId];
                }

                const variance = ((branch.proposedBudget - totalUserDesiredForBranch) / branch.proposedBudget) * 100;
                const varianceStatus = getVarianceStatus(variance);

                const branchDiv = document.createElement('div');
                branchDiv.className = `bg-white rounded-xl shadow-md p-4 mb-4 border-l-4 ${varianceStatus.borderClass}`;
                branchDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-navy-dark">${branch.name}</h3>
                        <span class="text-sm font-medium ${varianceStatus.textClass}">Variance: ${variance.toFixed(1)}% (${varianceStatus.status})</span>
                    </div>
                    <p class="text-gray-700 text-sm mt-1">Proposed: ${formatCurrency(branch.proposedBudget)}</p>
                    <p class="text-gray-700 text-sm">Your Desired: ${formatCurrency(totalUserDesiredForBranch)}</p>
                    <button class="mt-2 text-blue-600 hover:underline text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1" data-branch-id="${branch.id}" data-type="proposal-branch" aria-label="View department details for ${branch.name} proposal">View Departments</button>
                    <div id="proposal-departments-${branch.id}" class="mt-4 space-y-2 hidden"></div>
                `;
                budgetProposalBranchesList.appendChild(branchDiv);

                const viewDepartmentsButton = branchDiv.querySelector(`button[data-type="proposal-branch"]`);
                viewDepartmentsButton.addEventListener('click', (e) => {
                    const targetBranchId = e.target.dataset.branchId;
                    const departmentContainer = document.getElementById(`proposal-departments-${targetBranchId}`);
                    if (departmentContainer.classList.contains('hidden')) {
                        renderProposalDepartments(targetBranchId, departmentContainer);
                        departmentContainer.classList.remove('hidden');
                        e.target.textContent = 'Hide Departments';
                    } else {
                        departmentContainer.classList.add('hidden');
                        e.target.textContent = 'View Departments';
                    }
                });
            });

            showPage('budget-proposal-review');
        }

        function renderProposalDepartments(branchId, container) {
            container.innerHTML = ''; // Clear previous departments
            const budget = appData.budgets.find(b => b.id === 'travis-county-budget');
            const branch = budget.branches.find(b => b.id === branchId);

            if (!branch || !branch.departments || branch.departments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No detailed departments for this branch.</p>';
                return;
            }

            branch.departments.forEach(dept => {
                const userDesiredDept = (userBudgetContributions[budget.id] && userBudgetContributions[budget.id][branch.id] && userBudgetContributions[budget.id][branch.id].departments && userBudgetContributions[budget.id][branch.id].departments[dept.id]) || 0;
                const variance = ((dept.proposedBudget - userDesiredDept) / dept.proposedBudget) * 100;
                const varianceStatus = getVarianceStatus(variance);

                const deptDiv = document.createElement('div');
                deptDiv.className = `bg-gray-50 rounded-lg p-3 border-l-2 ${varianceStatus.borderClass}`;
                deptDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h4 class="text-base font-semibold text-navy-dark">${dept.name}</h4>
                        <span class="text-xs font-medium ${varianceStatus.textClass}">Variance: ${variance.toFixed(1)}%</span>
                    </div>
                    <p class="text-gray-600 text-sm">Proposed: ${formatCurrency(dept.proposedBudget)}</p>
                    <p class="text-gray-600 text-sm">Your Desired: ${formatCurrency(userDesiredDept)}</p>
                `;
                container.appendChild(deptDiv);
            });
        }

        function getVarianceStatus(variance) {
            if (variance >= 20) { // Proposed is 20% or more higher than desired
                return { status: 'Significantly Over', class: 'funding-blue', textClass: 'text-funding-blue', borderClass: 'border-funding-blue' };
            } else if (variance > 5) { // Proposed is 5-20% higher
                return { status: 'Moderately Over', class: 'funding-green', textClass: 'text-funding-green', borderClass: 'border-funding-green' };
            } else if (variance <= -20) { // Proposed is 20% or more lower than desired
                return { status: 'Significantly Under', class: 'funding-red', textClass: 'text-funding-red', borderClass: 'border-funding-red' };
            } else if (variance < -5) { // Proposed is 5-20% lower
                return { status: 'Moderately Under', class: 'funding-yellow', textClass: 'text-funding-yellow', borderClass: 'border-funding-yellow' };
            } else { // Within -5% to 5%
                return { status: 'Near Match', class: 'funding-green', textClass: 'text-funding-green', borderClass: 'border-funding-green' };
            }
        }


        // Function to render My Votes page
        function renderMyVotesPage() {
            myVotesList.innerHTML = ''; // Clear previous votes
            if (appData.userVotes.length === 0) {
                noVotesMessage.classList.remove('hidden');
            } else {
                noVotesMessage.classList.add('hidden');
                appData.userVotes.forEach(userVote => {
                    const bill = appData.bills.find(b => b.id === userVote.billId);
                    if (bill) { // Only display if the bill still exists in mock data
                        const voteCard = document.createElement('div');
                        voteCard.className = 'bg-white rounded-xl shadow-md p-4 flex items-center justify-between';
                        voteCard.innerHTML = `
                            <div>
                                <h3 class="text-lg font-semibold text-navy-dark">${bill.title}</h3>
                                <p class="text-sm text-gray-500">Voted on: ${new Date(userVote.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                            </div>
                            <span class="font-bold text-lg ${userVote.vote === 'yes' ? 'text-green-600' : 'text-red-600'}">
                                ${userVote.vote.toUpperCase()}
                            </span>
                        `;
                        myVotesList.appendChild(voteCard);
                    }
                });
            }
        }

        // Function to render My Profile page
        function renderMyProfilePage() {
            const profile = appData.userProfile;

            profileName.textContent = profile.name;
            profileHeadline.textContent = profile.headline;
            profileLocation.textContent = profile.location;
            profileBio.textContent = profile.bio;

            // Experience
            profileExperience.innerHTML = '';
            profile.experience.forEach(exp => {
                const li = document.createElement('li');
                li.className = 'border-b border-gray-200 pb-2 last:border-b-0';
                li.innerHTML = `
                    <p class="font-semibold text-navy-dark">${exp.title} at ${exp.company}</p>
                    <p class="text-sm text-gray-600">${exp.years}</p>
                    <p class="text-sm text-gray-700">${exp.description}</p>
                `;
                profileExperience.appendChild(li);
            });

            // Education
            profileEducation.innerHTML = '';
            profile.education.forEach(edu => {
                    const li = document.createElement('li');
                    li.className = 'border-b border-gray-200 pb-2 last:border-b-0';
                    li.innerHTML = `
                        <p class="font-semibold text-navy-dark">${edu.degree}</p>
                        <p class="text-sm text-gray-600">${edu.institution}, ${edu.years}</p>
                    `;
                    profileEducation.appendChild(li);
                });

            // Skills
            profileSkills.innerHTML = '';
            profile.skills.forEach(skill => {
                const span = document.createElement('span');
                span.className = 'bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full';
                span.textContent = skill;
                profileSkills.appendChild(span);
            });
        }

        // Function to render My Representatives page (including the map)
        function renderMyRepPage() {
            // Clear previous representatives list (below map)
            myRepsList.innerHTML = '';
            appData.representatives.forEach(rep => {
                const repCard = document.createElement('div');
                repCard.className = 'bg-white rounded-xl shadow-md p-4 flex items-center space-x-4';
                repCard.innerHTML = `
                    <img src="${rep.avatar}" alt="${rep.name}'s Avatar" class="w-16 h-16 rounded-full border-2 border-navy-dark">
                    <div>
                        <h3 class="text-xl font-bold text-navy-dark">${rep.name}</h3>
                        <p class="text-gray-700 text-sm">${rep.office} - ${rep.district}</p>
                        <p class="text-gray-600 text-xs">${rep.party}</p>
                        <p class="text-gray-600 text-sm mt-2">Email: <a href="mailto:${rep.contact}" class="text-blue-600 hover:underline">${rep.contact}</a></p>
                        <p class="text-gray-600 text-sm">Phone: <a href="tel:${rep.phone}" class="text-blue-600 hover:underline">${rep.phone}</a></p>
                    </div>
                `;
                myRepsList.appendChild(repCard);
            });

            // Initialize Three.js map
            initMap();
        }

        // --- Three.js Map Functions ---
        function initMap() {
            // Set canvas size
            const container = document.getElementById('map-container');
            mapCanvas.width = container.clientWidth;
            mapCanvas.height = container.clientHeight;

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f2f5); // Match body background

            // Camera (Orthographic for 2D)
            // Left, right, top, bottom, near, far
            camera = new THREE.OrthographicCamera(
                -mapCanvas.width / 2, mapCanvas.width / 2,
                mapCanvas.height / 2, -mapCanvas.height / 2,
                1, 1000
            );
            camera.position.z = 500; // Position camera back

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: mapCanvas, antialias: true });
            renderer.setSize(mapCanvas.width, mapCanvas.height);

            // Map Plane (Conceptual USA)
            const mapGeometry = new THREE.PlaneGeometry(MAP_WIDTH, MAP_HEIGHT); // A rectangle to represent the US area
            const mapMaterial = new THREE.MeshBasicMaterial({ color: 0xADD8E6, side: THREE.DoubleSide }); // Light blue
            mapPlane = new THREE.Mesh(mapGeometry, mapMaterial);
            scene.add(mapPlane);

            // Add border to the map plane
            const edges = new THREE.EdgesGeometry(mapGeometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x1A365D, linewidth: 2 }));
            mapPlane.add(line);


            // Add Pins
            pins.length = 0; // Clear existing pins
            appData.representatives.forEach(rep => {
                // Convert lat/lon to local map coordinates (simplified projection)
                // Assuming lat range ~25-50, lon range ~-125 to -65 for continental US
                // Normalize to 0-1 range, then scale to MAP_WIDTH/HEIGHT
                const normalizedLon = (rep.mapCoords.lon + 125) / (125 - 65); // ~0 to 1
                const normalizedLat = (rep.mapCoords.lat - 25) / (50 - 25);   // ~0 to 1

                const x = (normalizedLon * MAP_WIDTH) - (MAP_WIDTH / 2);
                const y = (normalizedLat * MAP_HEIGHT) - (MAP_HEIGHT / 2);

                const pinGeometry = new THREE.CircleGeometry(2, 32); // Pin size
                const pinMaterial = new THREE.MeshBasicMaterial({ color: 0xFF0000 }); // Red pin
                const pin = new THREE.Mesh(pinGeometry, pinMaterial);
                pin.position.set(x, y, 1); // Z-position slightly above map
                pin.userData = rep; // Store representative data
                scene.add(pin);
                pins.push(pin);
            });

            // Raycaster for clicks
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Event Listeners for Map Interaction
            mapCanvas.addEventListener('mousedown', onMapMouseDown, false);
            mapCanvas.addEventListener('mousemove', onMapMouseMove, false);
            mapCanvas.addEventListener('mouseup', onMapMouseUp, false);
            mapCanvas.addEventListener('wheel', onMapMouseWheel, false);

            mapCanvas.addEventListener('touchstart', onMapTouchStart, false);
            mapCanvas.addEventListener('touchmove', onMapTouchMove, false);
            mapCanvas.addEventListener('touchend', onMapTouchEnd, false);

            // Close modal button
            closeModalBtn.addEventListener('click', () => {
                repInfoModal.classList.remove('show');
            });

            // Initial render
            renderMap();
        }

        function renderMap() {
            renderer.render(scene, camera);
        }

        function animateMap() {
            requestAnimationFrame(animateMap);
            renderMap();
        }

        // --- Map Event Handlers ---

        function getClientCoords(event) {
            const rect = mapCanvas.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches && event.touches.length > 0) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function onMapMouseDown(event) {
            isMapDragging = true;
            lastPanPosition = { x: event.clientX, y: event.clientY };
        }

        function onMapMouseMove(event) {
            if (!isMapDragging) return;

            const deltaX = event.clientX - lastPanPosition.x;
            const deltaY = event.clientY - lastPanPosition.y;

            // Adjust camera position based on drag (pan)
            camera.position.x -= deltaX * camera.zoom * (camera.right - camera.left) / mapCanvas.width;
            camera.position.y += deltaY * camera.zoom * (camera.top - camera.bottom) / mapCanvas.height;

            lastPanPosition = { x: event.clientX, y: event.clientY };
            renderMap();
        }

        function onMapMouseUp(event) {
            isMapDragging = false;

            // Check for clicks on pins when mouse is released
            const coords = getClientCoords(event);
            mouse.x = (coords.x / mapCanvas.width) * 2 - 1;
            mouse.y = -(coords.y / mapCanvas.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(pins);

            if (intersects.length > 0) {
                const clickedPin = intersects[0].object;
                showRepInfo(clickedPin.userData);
            }
        }

        function onMapMouseWheel(event) {
            event.preventDefault(); // Prevent page scrolling

            const zoomFactor = 1.1;
            if (event.deltaY < 0) {
                camera.zoom *= zoomFactor; // Zoom in
            } else {
                camera.zoom /= zoomFactor; // Zoom out
            }
            camera.updateProjectionMatrix();
            renderMap();
        }

        function onMapTouchStart(event) {
            if (event.touches.length === 1) {
                isMapDragging = true;
                lastPanPosition = { x: event.touches[0].clientX, y: event.touches[0].clientY };
            } else if (event.touches.length === 2) {
                previousTouchDistance = getTouchDistance(event.touches);
            }
        }

        function onMapTouchMove(event) {
            event.preventDefault(); // Prevent scrolling/zooming the page

            if (event.touches.length === 1 && isMapDragging) {
                const currentTouchX = event.touches[0].clientX;
                const currentTouchY = event.touches[0].clientY;

                const deltaX = currentTouchX - lastPanPosition.x;
                const deltaY = currentTouchY - lastPanPosition.y;

                camera.position.x -= deltaX * camera.zoom * (camera.right - camera.left) / mapCanvas.width;
                camera.position.y += deltaY * camera.zoom * (camera.top - camera.bottom) / mapCanvas.height;

                lastPanPosition = { x: currentTouchX, y: currentTouchY };
                renderMap();
            } else if (event.touches.length === 2) {
                const currentTouchDistance = getTouchDistance(event.touches);
                const zoomFactor = currentTouchDistance / previousTouchDistance;

                camera.zoom *= zoomFactor;
                camera.updateProjectionMatrix();
                previousTouchDistance = currentTouchDistance;
                renderMap();
            }
        }

        function onMapTouchEnd(event) {
            isMapDragging = false;
            previousTouchDistance = 0;

            // Check for tap on pins (simpler click detection for touch)
            if (event.changedTouches.length === 1) {
                const touch = event.changedTouches[0];
                const coords = getClientCoords(touch);
                mouse.x = (coords.x / mapCanvas.width) * 2 - 1;
                mouse.y = -(coords.y / mapCanvas.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(pins);

                if (intersects.length > 0) {
                    const clickedPin = intersects[0].object;
                    showRepInfo(clickedPin.userData);
                }
            }
        }

        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function showRepInfo(rep) {
            modalRepName.textContent = rep.name;
            modalRepOffice.textContent = `${rep.office} - ${rep.district}`;
            modalRepParty.textContent = rep.party;
            modalRepEmail.textContent = rep.contact;
            modalRepEmail.href = `mailto:${rep.contact}`;
            modalRepPhone.textContent = rep.phone;
            modalRepPhone.href = `tel:${rep.phone}`;
            repInfoModal.classList.add('show');
        }

        // --- Event Listeners ---

        // Sidebar toggle
        openSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
            overlay.classList.add('open');
            mainContent.classList.add('shifted');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            mainContent.classList.remove('shifted');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            mainContent.classList.remove('shifted');
        });

        // Navigation links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.page;
                showPage(pageId);
            });
        });

        // Back buttons for budget pages
        backToBudgetsBtn.addEventListener('click', () => {
            showPage('budget');
        });

        backToBudgetBranchesBtn.addEventListener('click', () => {
            showBudgetDetail(currentBudgetId);
        });

        backToLegislationFromBudgetProposalBtn.addEventListener('click', () => {
            showPage('legislation');
        });

        // --- Swipe Voting Logic ---
        function resetSwipeCard() {
            swipeBillCard.style.transform = 'translateX(0)';
            swipeBillVoteYesIndicator.classList.remove('show');
            swipeBillVoteNoIndicator.classList.remove('show');
        }

        swipeBillCard.addEventListener('touchstart', (e) => {
            if (swipeBillCard.classList.contains('locked')) return;
            isDragging = true;
            startX = e.touches[0].clientX;
            swipeBillCard.style.transition = 'none'; // Disable transition during drag
        });

        swipeBillCard.addEventListener('touchmove', (e) => {
            if (!isDragging || swipeBillCard.classList.contains('locked')) return;
            currentX = e.touches[0].clientX;
            const diffX = currentX - startX;
            swipeBillCard.style.transform = `translateX(${diffX}px)`;

            // Show vote indicators based on swipe direction
            const cardWidth = swipeBillCard.offsetWidth;
            if (diffX > cardWidth * swipeThreshold) {
                swipeBillVoteYesIndicator.classList.add('show');
                swipeBillVoteNoIndicator.classList.remove('show');
            } else if (diffX < -cardWidth * swipeThreshold) {
                swipeBillVoteNoIndicator.classList.add('show');
                swipeBillVoteYesIndicator.classList.remove('show');
            } else {
                swipeBillVoteYesIndicator.classList.remove('show');
                swipeBillVoteNoIndicator.classList.remove('show');
            }
        });

        swipeBillCard.addEventListener('touchend', (e) => {
            if (!isDragging || swipeBillCard.classList.contains('locked')) return;
            isDragging = false;
            swipeBillCard.style.transition = 'transform 0.3s ease-out'; // Re-enable transition for snap

            const cardWidth = swipeBillCard.offsetWidth;
            const diffX = currentX - startX;
            let vote = null;

            if (diffX > cardWidth * swipeThreshold) {
                vote = 'yes';
            } else if (diffX < -cardWidth * swipeThreshold) {
                vote = 'no';
            }

            if (vote) {
                // Register vote in localStorage
                localStorage.setItem(`vote_${appData.bills[0].id}`, vote);

                // Add to mock userVotes for display on My Votes page
                const existingVoteIndex = appData.userVotes.findIndex(v => v.billId === appData.bills[0].id);
                if (existingVoteIndex > -1) {
                    appData.userVotes[existingVoteIndex] = { billId: appData.bills[0].id, vote: vote, date: new Date().toISOString().split('T')[0] };
                } else {
                    appData.userVotes.push({ billId: appData.bills[0].id, vote: vote, date: new Date().toISOString().split('T')[0] });
                }

                swipeBillCard.classList.add('locked');
                swipeBillVotedStatus.classList.remove('hidden');
                swipeBillVotedStatus.textContent = `You Voted: ${vote.toUpperCase()}`;
                if (vote === 'yes') {
                    swipeBillVotedStatus.classList.add('text-green-600');
                    swipeBillVotedStatus.classList.remove('text-red-600');
                } else {
                    swipeBillVotedStatus.classList.add('text-red-600');
                    swipeBillVotedStatus.classList.remove('text-green-600');
                }

                // Haptic feedback (if supported)
                if (navigator.vibrate) {
                    navigator.vibrate(100); // Vibrate for 100ms
                }

                // Animate card off-screen and then reset/lock
                swipeBillCard.style.transform = `translateX(${vote === 'yes' ? '150%' : '-150%'})`;
                setTimeout(() => {
                    resetSwipeCard(); // Reset position for next time (though locked)
                }, 300); // Match transition duration
            } else {
                resetSwipeCard(); // Snap back if not past threshold
            }
        });

        // Click on the swipeable bill card to go to details (even if not swiped)
        swipeBillCard.addEventListener('click', (e) => {
            // Only trigger if not actively dragging to prevent conflict with swipe
            if (!isDragging && Math.abs(currentX - startX) < 10) { // Small threshold to ignore accidental taps during drag attempts
                const firstBill = appData.bills[0];
                if (firstBill.isBudgetProposal) {
                    showBudgetProposalReview(firstBill.id);
                } else {
                    showBillDetail(firstBill.id);
                }
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('home'); // Start on the new home page
        });

        window.onload = function() {
            animateMap(); // Start the Three.js animation loop
        };

        // Handle window resize for the map canvas
        window.addEventListener('resize', () => {
            if (document.getElementById('my-rep-page').classList.contains('hidden')) return; // Only resize if map is visible

            const container = document.getElementById('map-container');
            mapCanvas.width = container.clientWidth;
            mapCanvas.height = container.clientHeight;

            // Update camera aspect ratio and projection matrix
            camera.left = -mapCanvas.width / 2;
            camera.right = mapCanvas.width / 2;
            camera.top = mapCanvas.height / 2;
            camera.bottom = -mapCanvas.height / 2;
            camera.updateProjectionMatrix();

            renderer.setSize(mapCanvas.width, mapCanvas.height);
            renderMap();
        });

    </script>
</body>
</html>
